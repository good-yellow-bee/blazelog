# BlazeLog Server ConfigMap
#
# Server configuration for Kubernetes deployment
# Secrets are injected via environment variables from Secrets
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: blazelog-server-config
  namespace: blazelog
  labels:
    app.kubernetes.io/name: blazelog
    app.kubernetes.io/component: server
data:
  server.yaml: |
    # BlazeLog Server Configuration for Kubernetes
    #
    # Secrets loaded from environment variables (Kubernetes Secrets)

    server:
      # gRPC listen address for agent connections
      grpc_address: ":9443"

      # HTTP listen address for REST API and Web UI
      http_address: ":8080"

      # Explicitly allow non-TLS mode (development only)
      allow_insecure: true

      # TLS configuration for mTLS (mutual TLS)
      # Enable for production with agent authentication
      tls:
        enabled: false
        # Uncomment when using TLS secrets:
        # cert_file: "/etc/blazelog/certs/tls.crt"
        # key_file: "/etc/blazelog/certs/tls.key"
        # client_ca_file: "/etc/blazelog/certs/ca.crt"

    # Database configuration
    # SQLite stored in PersistentVolume
    database:
      path: "/data/blazelog.db"

    # Authentication configuration
    # Secrets loaded from BLAZELOG_* environment variables
    auth:
      jwt_secret_env: "BLAZELOG_JWT_SECRET"
      csrf_secret_env: "BLAZELOG_CSRF_SECRET"
      access_token_ttl: "15m"
      refresh_token_ttl: "168h"  # 7 days
      rate_limit_per_ip: 100
      rate_limit_per_user: 1000
      lockout_threshold: 5
      lockout_duration: "15m"

    api:
      max_query_range: "24h"
      query_timeout: "10s"
      stream_max_duration: "30m"
      stream_poll_interval: "1s"

    # SSH security settings (for agentless log collection)
    ssh:
      host_key_file: "/etc/blazelog/known_hosts"
      host_key_policy: "strict"
      audit_log: "/data/ssh-audit.log"
      pool:
        max_per_host: 5
        idle_timeout: 5m

    # Metrics configuration
    metrics:
      enabled: true
      address: ":9090"

    # ClickHouse configuration
    # Enable for production with ClickHouse StatefulSet
    clickhouse:
      enabled: false
      addresses:
        - "blazelog-clickhouse:9000"
      database: "blazelog"
      username: "blazelog"
      password_env: "CLICKHOUSE_PASSWORD"
      batch_size: 10000
      flush_interval: "5s"
      max_buffer_size: 100000
      max_open_conns: 10
      retention_days: 90

  # SSH known_hosts (empty by default)
  known_hosts: ""
